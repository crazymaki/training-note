name: SonarCloud Analysis

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  sonarcloud:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up JDK 11
        uses: actions/setup-java@v2
        with:
          java-version: "11"

      - name: Cache SonarCloud
        uses: actions/cache@v2
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar-${{ hashFiles('**/sonar-project.properties') }}
          restore-keys: |
            ${{ runner.os }}-sonar-

      - name: Run SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@v2
        with:
          args: >
            -Dsonar.projectKey=crazymaki_training-note
            -Dsonar.organization=your-organization-key
            -Dsonar.host.url=https://sonarcloud.io
        continue-on-error: true # これによりエラー時も次のステップに進む

      - name: Check for successful scan
        id: sonar-status
        run: |
          if [[ "${{ steps.sonarcloud.outcome }}" == "success" ]]; then
            echo "SonarCloud scan was successful."
          else
            echo "SonarCloud scan failed."
            exit 1
          fi

      - name: Create GitHub Issue for successful scan
        if: success() # スキャンが成功した場合のみ実行
        run: |
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -d '{"title": "SonarCloud Scan Successful", "body": "SonarCloudのスキャンが正常に完了しました。問題はありません。"}' \
            https://api.github.com/repos/${{ github.repository }}/issues
